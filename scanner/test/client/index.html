<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NetSage Scanner - Test Client</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: #f4f6f8;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2a5885;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #2a5885;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #1e3f60;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f8f8;
      border-radius: 4px;
      border-left: 4px solid #2a5885;
      white-space: pre-wrap;
      font-family: monospace;
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #e7f7e7;
      border-left: 4px solid #28a745;
    }
    .error {
      background-color: #ffebee;
      border-left: 4px solid #dc3545;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NetSage Scanner Test Client</h1>
    
    <div class="form-group">
      <label for="serverUrl">Scanner Server URL:</label>
      <input type="text" id="serverUrl" value="http://localhost:3001" />
    </div>
    
    <div class="form-group">
      <label for="websiteUrl">Website to Scan:</label>
      <input type="text" id="websiteUrl" value="scanme.nmap.org" placeholder="e.g., example.com" />
    </div>
    
    <div class="form-group">
      <label for="requestId">Request ID (optional):</label>
      <input type="text" id="requestId" placeholder="Leave empty to generate automatically" />
    </div>
    
    <button id="testConnectionButton">Test Connection</button>
    <button id="scanButton">Start Scan</button>
    <button id="statusButton">Check Status</button>
    <button id="clearButton">Clear Output</button>
    
    <div id="output">Logs will appear here...</div>
  </div>

  <script>
    // DOM elements
    const serverUrlInput = document.getElementById('serverUrl');
    const websiteUrlInput = document.getElementById('websiteUrl');
    const requestIdInput = document.getElementById('requestId');
    const testConnectionButton = document.getElementById('testConnectionButton');
    const scanButton = document.getElementById('scanButton');
    const statusButton = document.getElementById('statusButton');
    const clearButton = document.getElementById('clearButton');
    const output = document.getElementById('output');
    
    // Log function with timestamp
    function log(message, isError = false) {
      const timestamp = new Date().toISOString().replace('T', ' ').substr(0, 19);
      const formattedMessage = `[${timestamp}] ${message}`;
      
      if (isError) {
        output.innerHTML += `<div class="status error">${formattedMessage}</div>\n`;
      } else {
        output.innerHTML += `${formattedMessage}\n`;
      }
      
      // Scroll to bottom
      output.scrollTop = output.scrollHeight;
    }
    
    // Format JSON for display
    function formatJSON(obj) {
      return JSON.stringify(obj, null, 2);
    }
    
    // Make API request
    async function makeRequest(url, method, body = null) {
      try {
        const options = {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          mode: 'cors', // Explicitly set CORS mode
          cache: 'no-cache' // Don't use cached responses
        };
        
        if (body) {
          options.body = JSON.stringify(body);
        }
        
        log(`Sending ${method} request to ${url}`);
        if (body) {
          log(`Request body: ${formatJSON(body)}`);
        }
        
        log('Attempting fetch with options: ' + JSON.stringify(options));
        const response = await fetch(url, options);
        
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        log(`Response (${response.status} ${response.statusText}):`);
        log(formatJSON(data));
        
        return { response, data };
      } catch (error) {
        log(`Error: ${error.message}`, true);
        log(`Details: Check if server at ${url} is running and CORS is enabled`, true);
        return null;
      }
    }
    
    // Start scan
    scanButton.addEventListener('click', async () => {
      const serverUrl = serverUrlInput.value.trim();
      const websiteUrl = websiteUrlInput.value.trim();
      const requestId = requestIdInput.value.trim();
      
      if (!serverUrl || !websiteUrl) {
        log('Please provide both Server URL and Website URL', true);
        return;
      }
      
      const body = {
        website_url: websiteUrl
      };
      
      if (requestId) {
        body.requestId = requestId;
      }
      
      const result = await makeRequest(`${serverUrl}/scan`, 'POST', body);
      
      if (result && result.data.requestId) {
        requestIdInput.value = result.data.requestId;
      }
    });
    
    // Check status
    statusButton.addEventListener('click', async () => {
      const serverUrl = serverUrlInput.value.trim();
      const requestId = requestIdInput.value.trim();
      
      if (!serverUrl || !requestId) {
        log('Please provide both Server URL and Request ID', true);
        return;
      }
      
      await makeRequest(`${serverUrl}/status/${requestId}`, 'GET');
    });
    
    // Clear output
    clearButton.addEventListener('click', () => {
      output.innerHTML = 'Logs will appear here...';
    });

    // Test Connection
    testConnectionButton.addEventListener('click', async () => {
      const serverUrl = serverUrlInput.value.trim();
      
      if (!serverUrl) {
        log('Please provide Server URL', true);
        return;
      }
      
      try {
        log(`Testing connection to ${serverUrl}...`);
        
        const testResponse = await fetch(`${serverUrl}/test`, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!testResponse.ok) {
          throw new Error(`HTTP error ${testResponse.status}`);
        }
        
        const testData = await testResponse.json();
        log('Connection test successful! Server response:');
        log(formatJSON(testData));
      } catch (error) {
        log(`Connection test failed: ${error.message}`, true);
        log('Possible causes:', true);
        log('1. Server not running at the specified URL', true);
        log('2. CORS not properly configured on server', true);
        log('3. Network connectivity issues', true);
      }
    });
  </script>
</body>
</html>
